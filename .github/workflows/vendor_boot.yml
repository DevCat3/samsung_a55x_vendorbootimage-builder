name: VENDOR_BOOT - TWRP

on:
  workflow_dispatch:
    inputs:
      DEVICE_TREE:
        description: 'Device Tree URL eg. https://github.com/<owner>/<repo>'
        required: true
        default: 'https://github.com/MrFluffyOven/android_device_samsung_a55x'
      DEVICE_BRANCH:
        description: 'Device Tree Branch, eg. twrp-12.1'
        required: true
        default: 'twrp-12.1'
      DEVICE_PATH:
        description: 'Device Path, eg. device/vendor/codename'
        required: true
        default: 'device/samsung/a55x'
      DEVICE_MAKEFILE:
        description: 'Device Makefile, eg. twrp_codename'
        required: true
        default: 'twrp_essi'
      STOCK_VENDOR_BOOT_URL:
        description: 'Direct URL to stock vendor_boot.img'
        required: true
      PRODUCT_NAME:
        description: 'Product name (codename), eg: a55x'
        required: true
      TWRP_VERSION:
        description: 'TWRP Version eg. 3.7.0_12'
        required: true
        default: '3.7.0_12'

jobs:
  build:
    name: Build vendor_boot by ${{ github.actor }}
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    
    steps:
    - name: Check Out
      uses: actions/checkout@v4
      
    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main
      
    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 12
        
    - name: Cache Repo Sync
      uses: actions/cache@v3
      with:
        path: |
          ~/android-recovery/.repo
          ~/android-recovery/prebuilts
        key: ${{ runner.os }}-repo-${{ inputs.DEVICE_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-repo-${{ inputs.DEVICE_BRANCH }}-
        
    - name: Prepare Environment
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          gperf gcc-multilib g++-multilib libc6-dev lib32ncurses5-dev \
          x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev \
          libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev \
          liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev \
          libxml2 lzop pngcrush schedtool squashfs-tools imagemagick \
          libbz2-dev lzma ncftp qemu-user-static libgflags-dev zip
        sudo add-apt-repository universe -y
        sudo apt-get install -y libncurses5

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '8'

    - name: Install Git-Repo
      run: |
        mkdir -p ~/bin
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo

    - name: Initialize & Sync Repo
      run: |
        mkdir -p android-recovery
        cd android-recovery
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ inputs.DEVICE_BRANCH }}
        sed -i '/<remove-project name="platform\/external\/gflags"  \/>/d' .repo/manifests/remove-minimal.xml
        repo sync -j$(nproc --all) --force-sync --no-clone-bundle
        
    - name: Clone Device Tree
      run: |
        cd android-recovery
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
      
    - name: Build TWRP Image 
      run: |
        cd android-recovery
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        lunch ${{ inputs.DEVICE_MAKEFILE }}-eng
        make clean
        make vendorbootimage -j$(nproc --all)
      
    - name: Prepare MagiskBoot
      run: |
        wget -q https://github.com/TeamWin/external_magisk-prebuilt/raw/android-12.1/prebuilt/magiskboot_x86_64 -O magiskboot
        chmod a+x magiskboot

    - name: Prepare Workspace & Download Stock
      run: |
        mkdir -p workspace/{stock,twrp}/unpack
        wget -q ${{ inputs.STOCK_VENDOR_BOOT_URL }} -O workspace/stock/stock-vb.img
        test -f workspace/stock/stock-vb.img || (echo "Failed to download stock image!" && exit 1)

    - name: Copy TWRP Image
      run: |
        TWRP_IMG="android-recovery/out/target/product/${{ inputs.PRODUCT_NAME }}/vendor_boot.img"
        test -f "$TWRP_IMG" || (echo "TWRP image not found at $TWRP_IMG!" && exit 1)
        cp "$TWRP_IMG" workspace/twrp/twrp-vb.img

    - name: Unpack, Patch & Create Archives
      run: |
        # Unpack both images
        cd workspace/stock/unpack && ${GITHUB_WORKSPACE}/magiskboot unpack ../stock-vb.img
        cd ../../twrp/unpack && ${GITHUB_WORKSPACE}/magiskboot unpack ../twrp-vb.img
        
        # Replace ramdisk and repack
        cd ../../
        mv twrp/unpack/vendor_ramdisk_recovery.cpio stock/unpack/
        cd stock/unpack
        ${GITHUB_WORKSPACE}/magiskboot repack ../stock-vb.img new-vendor_boot.img
        
        # Move final image to workspace root
        mv new-vendor_boot.img ../../vendor_boot.img
        
        # Create both tar and zip archives with version
        cd ../../
        tar -cvf twrp-vendor_boot-${{ inputs.PRODUCT_NAME }}-${{ inputs.TWRP_VERSION }}.tar vendor_boot.img
        zip twrp-vendor_boot-${{ inputs.PRODUCT_NAME }}-${{ inputs.TWRP_VERSION }}.zip vendor_boot.img

    - name: Set Build Date
      run: echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          twrp-vendor_boot-${{ inputs.PRODUCT_NAME }}-${{ inputs.TWRP_VERSION }}.tar
          twrp-vendor_boot-${{ inputs.PRODUCT_NAME }}-${{ inputs.TWRP_VERSION }}.zip
        name: "Unofficial TWRP v${{ inputs.TWRP_VERSION }} for ${{ inputs.PRODUCT_NAME }} // ${{ env.BUILD_DATE }}"
        tag_name: ${{ github.run_id }}-${{ inputs.PRODUCT_NAME }}-twrp${{ inputs.TWRP_VERSION }}-patched
        body: |
          # Flashable TWRP v${{ inputs.TWRP_VERSION }} for ${{ inputs.PRODUCT_NAME }}
          
          ## Build Details
          - **Device**: ${{ inputs.PRODUCT_NAME }}
          - **TWRP Version**: ${{ inputs.TWRP_VERSION }}
          - **Build Date**: ${{ env.BUILD_DATE }}
          - **Manifest Branch**: ${{ inputs.DEVICE_BRANCH }}
          
          ## Files Included
          - `.tar` - For ODIN flashing (rename to `.tar.md5` if needed)
          - `.zip` - For custom recovery installation
          
          ## Flashing Instructions
          ### Via ODIN:
          1. Extract the `.tar` file
          2. Use ODIN to flash `vendor_boot.img` to `VENDOR_BOOT` partition
          
          ### Via Fastboot:
          1. Extract the `.zip` file
          2. Use command: `fastboot flash vendor_boot vendor_boot.img`
          
          ---
          **Note**: This was built by replacing stock's vendor_ramdisk_recovery.cpio with TWRP's version.
